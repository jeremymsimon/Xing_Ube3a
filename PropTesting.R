library(presto)
library(vctrs)
library(purrr)
library(tidyselect)
library(dplyr)
library(Seurat)
library(DESeq2)
library(tidyverse)
library(speckle)

# Prep cell counts table for each cluster/timepoint/genotype/replicate
ctx.integrated = AddMetaData(ctx.integrated,metadata=paste0(ctx.integrated$time,".",ctx.integrated$gt,".",ctx.integrated$replicate),col.name="gtrep")


ctx.e14 = subset(ctx.integrated, subset = time == "E14")
ctx.p0 = subset(ctx.integrated, subset = time == "P0")

propeller(ctx.e14,sample=ctx.e14$orig.ident, group=ctx.e14$gt, clusters=ctx.e14$seurat_clusters,transform="asin")
propeller(ctx.p0,sample=ctx.p0$orig.ident, group=ctx.p0$gt, clusters=ctx.p0$seurat_clusters,transform="asin")

# E14

   BaselineProp.clusters BaselineProp.Freq PropMean.T485A PropMean.WT PropRatio
5                      5       0.047224634   0.0597696261 0.035395569 1.6886189
25                    25       0.021508249   0.0276685441 0.016648195 1.6619546
26                    26       0.017433705   0.0144161708 0.021053185 0.6847501
21                    21       0.028121034   0.0254470728 0.032429757 0.7846828
31                    31       0.017500501   0.0139351683 0.020286110 0.6869315
32                    32       0.017300114   0.0234322670 0.012897769 1.8167689
28                    28       0.012691203   0.0112115692 0.016792491 0.6676537
0                      0       0.055640906   0.0510235182 0.065287521 0.7815202
36                    36       0.003540178   0.0043084366 0.002265162 1.9020436
15                    15       0.023846102   0.0212881510 0.026691621 0.7975593
33                    33       0.010754125   0.0124167282 0.008812918 1.4089235
12                    12       0.035201389   0.0312642856 0.036965126 0.8457779
17                    17       0.020372721   0.0183518100 0.024221724 0.7576591
24                    24       0.017300114   0.0202741457 0.015991826 1.2677818
18                    18       0.029456950   0.0327900271 0.025130764 1.3047764
4                      4       0.037138468   0.0332881704 0.039836073 0.8356288
23                    23       0.013225569   0.0133476847 0.009489774 1.4065335
1                      1       0.069000067   0.0653309342 0.071668223 0.9115746
22                    22       0.010553737   0.0120678221 0.009703197 1.2436954
30                    30       0.018702825   0.0165331899 0.020981764 0.7879790
34                    34       0.007414334   0.0067227787 0.008344683 0.8056362
13                    13       0.028722196   0.0298913031 0.024845909 1.2030674
8                      8       0.036002939   0.0373113475 0.033316473 1.1199069
29                    29       0.016231381   0.0165912450 0.014190407 1.1691874
39                    39       0.001402712   0.0009082972 0.001668575 0.5443549
38                    38       0.005811235   0.0052682518 0.006720777 0.7838754
37                    37       0.004141340   0.0028610805 0.005049235 0.5666364
7                      7       0.032395966   0.0317562227 0.035346565 0.8984246
14                    14       0.033665086   0.0324775854 0.029795990 1.0899985
19                    19       0.029390154   0.0294453765 0.026071668 1.1294013
2                      2       0.033598290   0.0354202977 0.039079408 0.9063673
35                    35       0.008282680   0.0075783204 0.007074736 1.0711806
10                    10       0.029724133   0.0266886068 0.028983506 0.9208205
20                    20       0.021909024   0.0205405987 0.021181151 0.9697584
16                    16       0.033999065   0.0326131519 0.031459876 1.0366586
11                    11       0.033264311   0.0341517981 0.033687538 1.0137814
3                      3       0.046690268   0.0463830662 0.046131729 1.0054482
6                      6       0.043350478   0.0455556190 0.045451867 1.0022827
9                      9       0.032930332   0.0348149702 0.034235129 1.0169370
27                    27       0.014561486   0.0148547605 0.014816006 1.0026157
    Tstatistic     P.Value       FDR
5   3.98825635 0.001243417 0.0497367
25  2.65464359 0.018445851 0.3689170
26 -2.20575362 0.043345400 0.4464746
21 -2.02378732 0.061105739 0.4464746
31 -1.91434233 0.074767503 0.4464746
32  1.82287442 0.089223727 0.4464746
28 -1.78895351 0.093746185 0.4464746
0  -1.74641624 0.102102479 0.4464746
36  1.72306809 0.105335481 0.4464746
15 -1.60334258 0.129616400 0.4464746
33  1.55136296 0.141567767 0.4464746
12 -1.54347976 0.143459483 0.4464746
17 -1.51577983 0.150276659 0.4464746
24  1.49230114 0.156266124 0.4464746
18  1.39328147 0.184744143 0.4926510
4  -1.24021933 0.234535742 0.5501049
23  1.23526172 0.236577903 0.5501049
1  -1.20299127 0.247547226 0.5501049
22  1.05494316 0.308078711 0.6386734
30 -1.01080348 0.328710473 0.6386734
34 -0.97834662 0.343354905 0.6386734
13  0.95783781 0.354006755 0.6386734
8   0.91414887 0.375039566 0.6386734
29  0.89821434 0.383204020 0.6386734
39 -0.82773337 0.420742181 0.6731875
38 -0.69769751 0.495995463 0.7512544
37 -0.68022581 0.507096697 0.7512544
7  -0.59131119 0.563512239 0.7735949
14  0.57569573 0.573739725 0.7735949
19  0.56591326 0.580196144 0.7735949
2  -0.46992650 0.645469982 0.8277730
35  0.44604995 0.662218392 0.8277730
10 -0.35386197 0.728588234 0.8831373
20 -0.26181451 0.797010691 0.9223763
16  0.24875017 0.807079278 0.9223763
11  0.19379121 0.848928420 0.9314638
3   0.13071210 0.897784280 0.9314638
6   0.13000462 0.898367778 0.9314638
9   0.11729338 0.908177206 0.9314638
27  0.06425628 0.949611130 0.9496111


# P0

   BaselineProp.clusters BaselineProp.Freq PropMean.T485A PropMean.WT PropRatio
34                    34       0.012882671    0.009787246 0.016895551 0.5792795
26                    26       0.014406427    0.016805318 0.010158385 1.6543296
28                    28       0.021471118    0.025570637 0.017288529 1.4790522
2                      2       0.096689292    0.089751820 0.108974570 0.8236033
37                    37       0.015653138    0.014144913 0.022352596 0.6328085
15                    15       0.031306275    0.035331007 0.027134038 1.3020918
1                      1       0.043357806    0.046834558 0.036017863 1.3003147
9                      9       0.026735005    0.030099487 0.023649882 1.2727119
21                    21       0.006649120    0.007180870 0.004518417 1.5892449
4                      4       0.053054440    0.055176309 0.048194914 1.1448575
5                      5       0.028397285    0.025043843 0.029658473 0.8444077
0                      0       0.102784319    0.095662092 0.104903731 0.9119036
17                    17       0.033522649    0.036439777 0.031572353 1.1541673
24                    24       0.016345754    0.014861781 0.018458303 0.8051543
13                    13       0.026457958    0.028744287 0.024364889 1.1797422
22                    22       0.038093919    0.037940553 0.043505507 0.8720862
27                    27       0.018008034    0.016727267 0.020070428 0.8334285
29                    29       0.011913007    0.013182925 0.010763380 1.2247941
20                    20       0.020224408    0.019052250 0.022419947 0.8497901
23                    23       0.026180911    0.024184857 0.028008913 0.8634700
30                    30       0.005402410    0.004792346 0.005262522 0.9106558
25                    25       0.007203214    0.007139795 0.007520340 0.9493978
7                      7       0.053192963    0.056492048 0.052757961 1.0707777
3                      3       0.067045297    0.062977174 0.067262144 0.9362945
12                    12       0.014267904    0.015103445 0.013314134 1.1343918
19                    19       0.009142541    0.009854853 0.008254476 1.1938799
35                    35       0.009419587    0.009062176 0.010735098 0.8441633
31                    31       0.004709794    0.004205966 0.004302802 0.9774946
14                    14       0.012051531    0.012231378 0.010374000 1.1790416
18                    18       0.011358914    0.011420055 0.009796470 1.1657316
16                    16       0.006926167    0.007486636 0.006627971 1.1295517
6                      6       0.031721845    0.029790517 0.031543260 0.9444337
32                    32       0.004709794    0.004383566 0.003771531 1.1622778
10                    10       0.031998892    0.033236647 0.031469531 1.0561533
33                    33       0.009004017    0.008532063 0.009421469 0.9055980
11                    11       0.019116221    0.018681100 0.017707007 1.0550117
38                    38       0.011358914    0.012937862 0.012264342 1.0549169
8                      8       0.021055548    0.020569477 0.020380524 1.0092713
39                    39       0.008172877    0.008942944 0.009221386 0.9698047
36                    36       0.018008034    0.019638156 0.019102366 1.0280484
    Tstatistic    P.Value       FDR
34 -1.89773232 0.06959846 0.7693693
26  1.88837580 0.07089486 0.7693693
28  1.86126574 0.07477050 0.7693693
2  -1.84781690 0.07693693 0.7693693
37 -1.52764875 0.14093264 0.9162194
15  1.43100691 0.16508448 0.9162194
1   1.36965152 0.18469426 0.9162194
9   1.25549286 0.22116471 0.9162194
21  1.04079034 0.30815435 0.9162194
4   0.92377154 0.36463138 0.9162194
5  -0.91434249 0.37050696 0.9162194
0  -0.90558789 0.37411744 0.9162194
17  0.87860140 0.38816918 0.9162194
24 -0.87716392 0.38893406 0.9162194
13  0.87299187 0.39115954 0.9162194
22 -0.81762976 0.42146413 0.9162194
27 -0.72995499 0.47235301 0.9162194
29  0.72148661 0.47745246 0.9162194
20 -0.71620993 0.48064606 0.9162194
23 -0.65638858 0.51770370 0.9162194
30 -0.62554897 0.53748906 0.9162194
25 -0.61748633 0.54328974 0.9162194
7   0.49024782 0.62839140 0.9162194
3  -0.49016755 0.62889617 0.9162194
12  0.47471126 0.63920492 0.9162194
19  0.46925764 0.64304254 0.9162194
35 -0.46870893 0.64342922 0.9162194
31 -0.45163974 0.65556612 0.9162194
14  0.43935975 0.66425904 0.9162194
18  0.38287154 0.70517058 0.9384691
16  0.34445389 0.73344971 0.9384691
6  -0.28435490 0.77881308 0.9384691
32 -0.26603697 0.79270241 0.9384691
10  0.23847586 0.81352777 0.9384691
33 -0.22769197 0.82180600 0.9384691
11  0.14936584 0.88249001 0.9384691
38  0.12118846 0.90453209 0.9384691
8  -0.11556744 0.90895275 0.9384691
39 -0.10783388 0.91500736 0.9384691
36  0.01047558 0.99172807 0.9917281



# Cluster 5 has FDR < 0.05 at E14, but no other clusters at either timepoint reach significance after multiple testing correction
# Clusters 25 and 26 have nominal p < 0.05 at E14. No clusters even reach that level at P0

